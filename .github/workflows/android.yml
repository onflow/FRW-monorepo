name: Android Build & Release

on:
  push:
    paths:
      - "apps/react-native/**"
      - "packages/**"
      - "pnpm-lock.yaml"
      - ".github/workflows/android.yml"
    branches: [main, dev, "release/*"]
    tags:
      - "release/rn-*"
  pull_request:
    paths:
      - "apps/react-native/**"
      - "packages/**"
    branches: [main, dev, "release/*"]
  workflow_dispatch:
    inputs:
      buildType:
        description: "Build type (debug|dev|release)"
        default: "debug"
        required: true

jobs:
  android:
    runs-on: ubuntu-latest
    env:
      # GitHub Packages (Flow Wallet Kit + wallet-core)
      GITHUB_USERNAME: ${{ secrets.GPR_USER }}
      GITHUB_TOKEN: ${{ secrets.GPR_KEY }}
      # Also expose as Gradle properties preferred by our build
      GPR_USER: ${{ secrets.GPR_USER }}
      GPR_KEY: ${{ secrets.GPR_KEY }}

      # Firebase App Distribution (optional; used on release paths/tags)
      FIREBASE_TESTERS: ${{ secrets.FIREBASE_TESTERS }}
      ANDROID_FIREBASE_CREDENTIALS_B64: ${{ secrets.ANDROID_FIREBASE_CREDENTIALS_B64 }}

      # Monorepo paths
      RN_APP_DIR: apps/react-native
      ANDROID_DIR: apps/react-native/android

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build monorepo packages
        run: pnpm -r --filter='./packages/*' build

      - name: Regenerate RN bridge models
        run: pnpm -F "frw-rn" codegen:bridge

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Install Android SDK components
        shell: bash
        run: |
          yes | sudo ${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager \
            "platform-tools" \
            "platforms;android-35" \
            "build-tools;35.0.0" \
            "platforms;android-36" || true

      - name: Prepare Android config files
        shell: bash
        run: |
          set -euo pipefail
          cd "$ANDROID_DIR"

          # Configure Gradle properties for GitHub Packages auth
          mkdir -p "$HOME/.gradle"
          {
            echo "gpr.user=${GPR_USER:-}"
            echo "gpr.key=${GPR_KEY:-}"
          } >> "$HOME/.gradle/gradle.properties"

          # Optional: Google Services JSONs (base64 secrets)
          if [ -n "${{ secrets.ANDROID_GOOGLE_SERVICES_DEV_B64 }}" ]; then
            echo "${{ secrets.ANDROID_GOOGLE_SERVICES_DEV_B64 }}" | base64 -d > app/google-services.json || true
          fi
          if [ -n "${{ secrets.ANDROID_GOOGLE_SERVICES_PROD_B64 }}" ]; then
            mkdir -p app/src/release
            echo "${{ secrets.ANDROID_GOOGLE_SERVICES_PROD_B64 }}" | base64 -d > app/src/release/google-services.json || true
          fi

          # Optional: key.properties (signing) via base64
          if [ -n "${{ secrets.ANDROID_KEY_PROPERTIES_B64 }}" ]; then
            echo "${{ secrets.ANDROID_KEY_PROPERTIES_B64 }}" | base64 -d > key.properties
          fi

          # Optional: Firebase App Distribution service account
          if [ -n "${{ secrets.ANDROID_FIREBASE_CREDENTIALS_B64 }}" ]; then
            echo "${{ secrets.ANDROID_FIREBASE_CREDENTIALS_B64 }}" | base64 -d > firebase-appdist.json
            # Ensure local.properties provides serviceCredentialsFile & testers
            {
              echo "sdk.dir=${ANDROID_SDK_ROOT}"
              echo "serviceCredentialsFile=$(pwd)/firebase-appdist.json"
              echo "testers=${FIREBASE_TESTERS:-}"
            } > local.properties
          fi

      - name: Determine build type
        id: meta
        shell: bash
        run: |
          # Decide buildType: PRs -> debug; Release tags/branches -> dev (if secrets present) else debug
          INPUT="${{ github.event_name }}:${{ github.ref }}:${{ inputs.buildType }}"
          TYPE="debug"
          if [[ "${{ github.event_name }}" == "push" ]]; then
            if [[ "${{ github.ref }}" == refs/tags/release/rn-* || "${{ github.ref }}" == refs/heads/release/* ]]; then
              TYPE="dev"
            fi
          fi
          if [[ -n "${{ inputs.buildType }}" ]]; then TYPE="${{ inputs.buildType }}"; fi
          echo "buildType=$TYPE" >> $GITHUB_OUTPUT
          echo "Resolved build type: $TYPE"

      - name: Build Android (${{ steps.meta.outputs.buildType }})
        working-directory: ${{ env.ANDROID_DIR }}
        run: |
          case "${{ steps.meta.outputs.buildType }}" in
            debug)
              ./gradlew :app:assembleDebug --stacktrace
              ;;
            dev)
              ./gradlew :app:assembleDev --stacktrace
              ;;
            release)
              ./gradlew :app:assembleRelease --stacktrace
              ;;
          esac

      - name: Generate release notes (last 3 days)
        if: steps.meta.outputs.buildType == 'dev'
        shell: bash
        run: |
          set -euo pipefail
          REPO_ROOT="$GITHUB_WORKSPACE"
          NOTES_FILE="$REPO_ROOT/apps/react-native/android/release-notes.txt"
          if [ -z "${ANDROID_FIREBASE_CREDENTIALS_B64:-}" ] || [ -z "${FIREBASE_TESTERS:-}" ]; then
            echo "[Android CI] Firebase credentials or testers not set; skipping release notes generation."
            exit 0
          fi
          echo "[Android CI] Generating Firebase App Distribution release notes..."

          # Ensure sufficient git history for logs
          (git fetch --unshallow 2>/dev/null || git fetch --deepen=50) || true

          # Compute date 3 days ago (GNU date on ubuntu)
          SINCE_DATE=$(date -d '3 days ago' '+%Y-%m-%d')

          {
            echo "What's New in This Build"
            echo "========================"
            echo

            # Collect merge commits and extract PR + issue info
            MERGES=$(git log --since="$SINCE_DATE" --merges --pretty=format:'%H|%s|%b|%ct' 2>/dev/null || true)
            if [ -n "$MERGES" ]; then
              TMP_ITEMS=$(mktemp)
              while IFS='|' read -r commit_hash subject body ts; do
                [ -z "${commit_hash:-}" ] && continue
                PR_AND_SLUG=$(echo "$subject" | sed -n 's/.*Merge pull request #\([0-9][0-9]*\) from [^/]*\/\([^ ]*\).*/\1|\2/p')
                [ -z "${PR_AND_SLUG:-}" ] && continue
                PR_NUM=$(echo "$PR_AND_SLUG" | cut -d'|' -f1)
                BRANCH_SLUG=$(echo "$PR_AND_SLUG" | cut -d'|' -f2)
                ISSUE_NUM=$(echo "$BRANCH_SLUG" | sed -n 's/^\([0-9][0-9]*\).*/\1/p')
                PR_TITLE=$(echo "$body" | sed -n '/./{s/^\s*//;p;q;}')
                if [ -z "${PR_TITLE:-}" ]; then
                  PR_TITLE=$(echo "$BRANCH_SLUG" | sed -E 's/^[0-9]+-//' | sed -E 's/[-_]+/ /g')
                  PR_TITLE=$(awk 'BEGIN{FS="\n"} {if (length($0)>0){$1=toupper(substr($1,1,1)) substr($1,2)}; print}' <<< "$PR_TITLE")
                fi
                echo "$ts|$ISSUE_NUM|$PR_TITLE|$PR_NUM" >> "$TMP_ITEMS"
              done < <(echo "$MERGES")

              if [ -s "$TMP_ITEMS" ]; then
                echo "Resolved Issues:"
                sort -t'|' -k1 -nr "$TMP_ITEMS" | awk -F'|' 'BEGIN{OFS="|"} { key = ($2 != "" ? $2 : $4); if (!seen[key]++) print $0; }' |
                while IFS='|' read -r _ts issue title pr; do
                  if [ -n "$issue" ]; then
                    echo "  • #$issue: $title (PR #$pr)"
                  else
                    echo "  • $title (PR #$pr)"
                  fi
                done
                echo
                echo "------------------------"
                echo
              fi
            fi

            echo "Recent Changes:"
            echo
            git log --since="$SINCE_DATE" --pretty=format:'  • %s (%an)' | head -8 || true
            RECENT_COUNT=$(git log --since="$SINCE_DATE" --oneline 2>/dev/null | wc -l | tr -d ' ')
            if [ "${RECENT_COUNT:-0}" -eq 0 ]; then
              echo "  • No commits in last 3 days"
              git log --pretty=format:'  • %s (%an, %ar)' | head -5 || true
            fi

            echo
            echo "------------------------"
            echo
            echo "Build Information:"
            echo "  • Build Date (Sydney): $(TZ=Australia/Sydney date '+%Y-%m-%d %H:%M %Z')"
            echo "  • Branch: $(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo 'detached')"
            echo "  • Latest Commit: $(git log -1 --pretty=format:'%h - %s' 2>/dev/null || true)"
            echo "  • Total Commits (3 days): $(git log --since="$SINCE_DATE" --oneline 2>/dev/null | wc -l | tr -d ' ')"

            echo
            echo "------------------------"
            echo
            echo "Thank you for testing!"
          } > "$NOTES_FILE"

          echo "[Android CI] Release notes written to $NOTES_FILE"
          echo "FIREBASE_APP_DIST_RELEASE_NOTES_FILE=$NOTES_FILE" >> $GITHUB_ENV

      - name: Upload APK artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ steps.meta.outputs.buildType }}-apk
          path: |
            apps/react-native/android/app/build/outputs/apk/**/**/*.apk
          if-no-files-found: warn

      - name: Firebase App Distribution (dev)
        if: steps.meta.outputs.buildType == 'dev'
        working-directory: ${{ env.ANDROID_DIR }}
        run: |
          if [ ! -f firebase-appdist.json ] || [ -z "${FIREBASE_TESTERS:-}" ]; then
            echo "[Android CI] Firebase credentials or testers not configured; skipping App Distribution upload."
            exit 0
          fi
          ./gradlew :app:appDistributionUploadDev --stacktrace
