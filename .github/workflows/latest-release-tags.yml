name: Update Latest Release Tags

on:
  push:
    tags:
      - release/ios-*
      - release/android-*
      - release/extension-*
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag to point the corresponding *-latest tag at (e.g. release/ios-1.2.3)"
        required: true

permissions:
  contents: write

jobs:
  retag-latest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.release_tag || github.ref || github.event.ref }}

      - name: Determine latest tag target
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          event="${{ github.event_name }}"
          ref="${GITHUB_REF#refs/tags/}"
          if [ "$event" = "workflow_dispatch" ]; then
            ref="${{ inputs.release_tag }}"
            if [ -z "$ref" ]; then
              echo "release_tag input is required for manual runs."
              exit 1
            fi
          fi
          case "$ref" in
            release/ios-*)
              latest_tag="ios-latest"
              ;;
            release/android-*)
              latest_tag="android-latest"
              ;;
            release/extension-*)
              latest_tag="extension-latest"
              ;;
            *)
              echo "Unsupported tag pattern: $ref"
              exit 1
              ;;
          esac
          target_sha="$GITHUB_SHA"
          if [ "$event" = "workflow_dispatch" ]; then
            git fetch --tags --force
            target_sha="$(git rev-list -n 1 "refs/tags/$ref" || true)"
            if [ -z "$target_sha" ]; then
              echo "Tag not found: $ref"
              exit 1
            fi
          fi
          echo "source_tag=$ref" >> "$GITHUB_OUTPUT"
          echo "latest_tag=$latest_tag" >> "$GITHUB_OUTPUT"
          echo "target_sha=$target_sha" >> "$GITHUB_OUTPUT"

      - name: Move latest tag to release
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          latest="${{ steps.meta.outputs.latest_tag }}"
          target="${{ steps.meta.outputs.target_sha }}"
          git tag -f "$latest" "$target"
          git push -f origin "$latest"
          echo "Updated $latest to $target from ${{ steps.meta.outputs.source_tag }}"
